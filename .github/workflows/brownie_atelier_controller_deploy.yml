name: Brownie Atelier Controller Deploy
run-name: Brownie Atelier Controller Deploy!!!
on:
    # ä»¥ä¸‹ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸéš›èµ·å‹•
    push:
        branches: ['develop','master']
    # Githubã‚ˆã‚Šæ‰‹å‹•ã§èµ·å‹•
    workflow_dispatch:

jobs:

  Branch-Controll:
    runs-on: ubuntu-22.04
    steps:
      - name: ãƒ–ãƒ©ãƒ³ãƒã‚ˆã‚Šç’°å¢ƒã‚’é¸æŠ (ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒï¼š ${{ github.ref }})
        id: branch_check
        run: |
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "env_name=PRODUCT" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "env_name=TEST" >> $GITHUB_OUTPUT
          else
            echo "env_name=TEST" >> $GITHUB_OUTPUT
          fi         
          
      - run: echo "ç’°å¢ƒåï¼š ${{ steps.branch_check.outputs.env_name }}"
        
    outputs:
      env_name: ${{ steps.branch_check.outputs.env_name }}

  Brownie-Atelier-Controller-Deploy:
    # ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †å‚è€ƒã‚µã‚¤ãƒˆ : https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-how-to-github-actions?tabs=linux%2Cpython&pivots=method-manual#tabpanel_2_python_windows
    needs: [Branch-Controll]
    runs-on: ubuntu-22.04
    environment:
      name: ${{ needs.Branch-Controll.outputs.env_name }}
    env:
      AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'       # set this to the path to your function app project, defaults to the repository root
      PYTHON_VERSION: '3.10'
    

    steps:
      - run: echo "ğŸ‰ èµ·å‹•ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ (${{ github.event_name }})"
      - run: echo "ğŸ§ githubä¸Šã®OSã®ç¨®é¡ (${{ runner.os }})"
      - name: ãƒªãƒã‚¸ãƒˆãƒª(${{ github.repository }})ãƒ»ãƒ–ãƒ©ãƒ³ãƒ(${{ github.ref }})ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        # ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ»ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          submodules: true  # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å«ã‚ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          fetch-depth: 0    # å…¨ã¦ã®å±¥æ­´ã‚’ãƒ•ã‚§ãƒƒãƒ
          # token: ${{ secrets.GITHUB_TOKEN }}  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦

      - name: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯
        # ã‚¯ãƒ­ãƒ¼ãƒ³å¾Œã¯ã“ã“ã«ã‚½ãƒ¼ã‚¹ãŒæ ¼ç´ã•ã‚Œã‚‹ /home/runner/work/BrownieAtelierController/BrownieAtelierController
        run: |
          ls -a ${{ github.workspace }}

      #################################################
      # Azure Functionsã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      #################################################
      - name: Setup Python ${{ env.PYTHON_VERSION }} Environment
        uses: actions/setup-python@v5
        with:
            python-version: ${{ env.PYTHON_VERSION }}

      - name: 'Resolve Project Dependencies Using Pip'
        shell: bash
        run: |
          pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          python -m pip install --upgrade pip
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"
          popd

      - name: 'Run Azure Functions Action'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ vars.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          scm-do-build-during-deployment: true
          enable-oryx-build: true
